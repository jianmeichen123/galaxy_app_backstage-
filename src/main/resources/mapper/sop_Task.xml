<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.galaxy.im.bean.soptask.SopTask">
	
	
	<!-- 查询列表 -->
	<select id="taskListByRole" parameterType="hashmap"
		resultType="hashmap">
		SELECT st.id,st.task_name taskName, d.name  taskType,
		st.task_flag taskFlag,st.created_time createdTime, st.task_status status,
		sp.create_uname createdUname,sp.project_name projectName,sp.id projectId,
		p.user_name assignUserName
		FROM sop_task st 
		LEFT JOIN sop_project sp ON st.project_id = sp.id
		LEFT JOIN dict d on st.task_type = d.dict_code
		LEFT JOIN power.user p ON st.assign_uid = p.id
		WHERE  
		st.department_id=#{depId}
		<if test="taskStatus != null" > and st.task_status = #{taskStatus}</if>
		<if test="assignUid != null" > and st.assign_uid = #{assignUid}</if>
		<if test="keyWord != null" > and 
		(upper(sp.project_name) like CONCAT('%',upper(#{keyWord}),'%') OR upper(sp.create_uname) LIKE CONCAT('%',upper(#{keyWord}),'%'))
		</if>
		<if test="property != null" >
		order by ${property} ${direction}
		</if>
		<if test="offset != null" >
		limit #{offset},${limit};
		</if>

	</select>

	<!-- 列表记录个数 -->
	<select id="taskListCount" parameterType="hashmap"
		resultType="integer">
		select
		count(1)
		FROM sop_task st 
		LEFT JOIN sop_project sp ON st.project_id = sp.id
		WHERE  
		st.department_id=#{depId}
		<if test="taskStatus != null" > and st.task_status = #{taskStatus}</if>
		<if test="assignUid != null" > and st.assign_uid = #{assignUid}</if>
		<if test="keyWord != null" > and 
		(upper(sp.project_name) like CONCAT('%',upper(#{keyWord}),'%') OR upper(sp.create_uname) LIKE CONCAT('%',upper(#{keyWord}),'%'))
		</if>
	</select>
	
	<!-- 部门id -->
	<select id="selectDeptId" parameterType="hashmap"
		resultType="long">
		SELECT dep_id depID from power.rel_dep_user WHERE user_id = #{id}
	</select>
	
	<!-- 待办任务详情 -->
	<select id="taskInfo" parameterType="hashmap"
		resultType="hashmap">
		SELECT p4.*,st.task_name taskName
		FROM sop_task st LEFT JOIN
		(
		SELECT p3.*,u1.user_name partner
		from
		(SELECT p2.*,d.dep_manager depManager
		from
		(
		SELECT p1.id,p1.project_careerline projectCareerline,u.user_name userName,
		 p1.project_name projectName,dd.name projectType, p1.project_code projectCode,p1.created_time createdTime, 
		 p1.project_company projectCompany
		FROM sop_project p1 LEFT JOIN power.user u ON p1.create_uid = u.id
		LEFT JOIN dict dd ON dd.dict_code =p1.project_type
		WHERE p1.id = #{projectId}) p2  LEFT JOIN power.department d ON p2.projectCareerline = d.dep_name) p3
		LEFT JOIN power.user u1 ON p3.depManager = u1.id) p4 ON st.project_id = p4.id 
		WHERE st.id =#{id}
	</select>
	

	
	
</mapper>