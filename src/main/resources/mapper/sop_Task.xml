<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.galaxy.im.bean.soptask.SopTask">
	
	
	<!-- 查询列表 -->
	<select id="taskListByRole" parameterType="hashmap"
		resultType="hashmap">
		SELECT st.id,st.task_name taskName, d.name  taskType,
		st.task_flag taskFlag,st.created_time createdTime, st.task_status status,
		sp.create_uname projectCreatedName,sp.project_name projectName,sp.id projectId,
		p.user_name assignUserName,st.assign_uid assignUid,sp.create_uid projectCreatedId
		FROM sop_task st 
		LEFT JOIN sop_project sp ON st.project_id = sp.id
		LEFT JOIN dict d on st.task_type = d.dict_code
		LEFT JOIN power.user p ON st.assign_uid = p.id
		WHERE  
		st.department_id=#{depId}
		<if test="taskStatus != null" > and st.task_status = #{taskStatus}</if>
		<if test="assignUid != null" > and st.assign_uid = #{assignUid}</if>
		<if test="keyWord != null" > and 
		(upper(sp.project_name) like CONCAT('%',upper(#{keyWord}),'%') OR upper(sp.create_uname) LIKE CONCAT('%',upper(#{keyWord}),'%'))
		</if>
		<if test="property != null and direction != null" >
		order by ${property} ${direction}
		</if>
		<if test="offset != null and limit !=null" >
		limit #{offset},${limit};
		</if>

	</select>

	<!-- 列表记录个数 -->
	<select id="taskListCount" parameterType="hashmap"
		resultType="integer">
		select
		count(1)
		FROM sop_task st 
		LEFT JOIN sop_project sp ON st.project_id = sp.id
		WHERE  
		st.department_id=#{depId}
		<if test="taskStatus != null" > and st.task_status = #{taskStatus}</if>
		<if test="assignUid != null" > and st.assign_uid = #{assignUid}</if>
		<if test="keyWord != null" > and 
		(upper(sp.project_name) like CONCAT('%',upper(#{keyWord}),'%') OR upper(sp.create_uname) LIKE CONCAT('%',upper(#{keyWord}),'%'))
		</if>
	</select>
	
	<!-- 部门id -->
	<select id="selectDeptId" parameterType="hashmap"
		resultType="long">
		SELECT dep_id depID from power.rel_dep_user WHERE user_id = #{id}
	</select>
	
	<!-- 待办任务详情 -->
	<select id="taskInfo" parameterType="hashmap"
		resultType="hashmap">
		SELECT p4.*,st.task_name taskName,st.assign_uid assignUid,st.id taskId
		FROM sop_task st LEFT JOIN
		(
		SELECT p3.*,u1.user_name partner
		from
		(SELECT p2.*,d.dep_manager depManager
		from
		(
		SELECT p1.id projectId,p1.project_careerline projectCareerline,u.user_name projectCreatedName,p1.create_uid projectCreatedId,
		 p1.project_name projectName,dd.name projectType, p1.project_code projectCode,p1.created_time createdTime, 
		 p1.project_company projectCompany
		FROM sop_project p1 LEFT JOIN power.user u ON p1.create_uid = u.id
		LEFT JOIN dict dd ON dd.dict_code =p1.project_type
		WHERE p1.id = #{projectId}) p2  LEFT JOIN power.department d ON p2.projectCareerline = d.dep_name) p3
		LEFT JOIN power.user u1 ON p3.depManager = u1.id) p4 ON st.project_id = p4.projectId 
		WHERE st.id =#{id}
	</select>
	
	<!-- 修改项目状态 为认领-->
	<update id="applyTask" parameterType="com.galaxy.im.bean.soptask.SopTask">
		update sop_task 
		<set>
			<if test="assignUid != null">  assign_uid =#{assignUid},</if>
			<if test="taskStatus != null">  task_status =#{taskStatus},</if>
			<if test="updatedTime != null">  updated_time =#{updatedTime}</if>
		</set>
		<where>
			<trim prefixOverrides="and">
				<if test="id != null"> and id =#{id}</if>
				<if test="projectId != null"> and project_id =#{projectId}</if>
				<if test="taskType != null"> and task_type =#{taskType}</if>
				<if test="taskFlag != null"> and task_flag =#{taskFlag}</if>
			</trim>
		</where>
	</update>
	
	<!-- 指派/移交 -->
	<insert id="taskTransfer" parameterType="com.galaxy.im.bean.soptask.SopTaskRecord">
		insert into sop_task_record(
			task_id,
			before_uid,
			before_department_id,
			after_uid,
			after_department_id,
			reason,
			record_type,
			is_del,
			created_uid,
			updated_uid,
			created_time
		)values (
        	#{taskId},
			#{beforeUid},
			#{beforeDepartmentId},
			#{afterUid},
			#{afterDepartmentId},
			#{reason},
			#{recordType},
			#{isDel},
			#{createdUid},
			#{updatedUid},
			#{createdTime}
   		)
		<selectKey resultType="java.lang.Long" order="AFTER" keyProperty="id">
				SELECT LAST_INSERT_ID() AS id
		</selectKey>
	</insert>
	
	<!-- 更新待办任务 -->
	<update id="updateTask" parameterType="com.galaxy.im.bean.soptask.SopTask">
		update sop_task
			<trim prefix="set" suffixOverrides=",">
			<if test="assignUid != null" >assign_uid = #{assignUid},</if>
			<if test="updatedId != null" > updated_id = #{updatedId},</if>
			<if test="updatedTime != null" >updated_time = #{updatedTime},</if>
			<if test="taskStatus != null" >task_status = #{taskStatus}</if>
			</trim>
		where id = #{id}
	</update>
	
	<!-- 人事/财务/法务是否上传报告 -->
	<select id="isUpload" parameterType="com.galaxy.im.bean.talk.SopFileBean"
		resultType="com.galaxy.im.bean.talk.SopFileBean">
		SELECT id,belong_uid belongUid,file_uid fileUid FROM sop_file WHERE project_id=#{projectId} 
		AND file_valid=1 AND file_uid =#{fileUid} and file_worktype=#{fileWorkType}
	</select>
	
	<!-- 更新文件信息 -->
	<update id="updateFile" parameterType="com.galaxy.im.bean.talk.SopFileBean">
		update sop_file set
		<if test="belongUid != null" >belong_uid = #{belongUid},</if>
		<if test="fileValid != null" >file_valid = #{fileValid},</if>
		<if test="updatedTime != null" >updated_time= #{updatedTime}</if>
		where id = #{id} and file_valid=1
	</update>
	
	<!-- 查询是否已经移交/指派-->
	<select id="selectRecord" parameterType="com.galaxy.im.bean.soptask.SopTaskRecord"
		resultType="com.galaxy.im.bean.soptask.SopTaskRecord">
		SELECT * FROM sop_task_record WHERE task_id=#{taskId} 
		AND after_uid =#{afterUid} and before_uid=#{beforeUid}
	</select>
	
	<!-- 查询是否有操作日志-->
	<select id="getOperationLogs" parameterType="com.galaxy.im.bean.operationLog.OperationLogs"
		resultType="integer">
		select count(1) FROM sop_operation_logs 
		WHERE record_type=4 and uid=#{uid} and record_id=#{recordId}
	</select>
	
	
</mapper>