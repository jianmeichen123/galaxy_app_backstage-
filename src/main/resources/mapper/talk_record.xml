<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper  
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="com.galaxy.im.bean.talk.TalkRecordBean">
	
	<!-- 访谈记录list -->
	<select id="select" resultType="com.galaxy.im.bean.talk.TalkRecordBean" parameterType="java.util.Map" resultMap="talkMap">
		SELECT id,
		date_format(view_date,'%Y/%m/%d %H:%i') viewDate,
		view_target viewTarget 
		FROM sop_interview_record WHERE 1=1
		<choose>
			<when test="proId!=0">
				and schedule_id=#{callonId} and project_id=#{proId}
			</when>
			<when test="conId!=0">
				and schedule_id in ( SELECT schedule_id FROM schedule_person_plan WHERE contacts_id=#{conId})
			</when>
		</choose>
		GROUP BY view_date desc
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit};
		</if>
	</select>
	<resultMap type="com.galaxy.im.bean.talk.TalkRecordBean" id="talkMap">
		<result column="id" property="id"/>
		<result column="viewDate" property="viewDate"/>
		<result column="viewTarget" property="viewTarget"/>
	</resultMap>
	
	<!-- 访谈记录list总数 -->
	<select id="selectCount" resultType="java.lang.Long"
		parameterType="java.util.Map">
		SELECT COUNT(1) FROM sop_interview_record WHERE 1=1
		<choose>
			<when test="proId!=0">
				and schedule_id=#{callonId} and project_id=#{proId};
			</when>
			<when test="conId!=0">
				and schedule_id in ( SELECT schedule_id FROM schedule_person_plan WHERE contacts_id=#{conId});
			</when>
		</choose>
	</select>
	
	<!-- 添加访谈记录 -->
	<insert id="insert" useGeneratedKeys="true" keyProperty="id"  keyColumn="id" parameterType="com.galaxy.im.bean.talk.TalkRecordBean" >
		insert into sop_interview_record (id, project_id, file_id, view_date, 
		  	view_target, view_notes, view_notes_text, created_time, created_id, update_time,schedule_id)
	    values (#{id}, #{projectId}, #{fileId}, #{viewDate}, #{viewTarget}, #{viewNotes}, 
	    	#{viewNotesText}, #{createdTime},#{createdId},#{createdTime},#{scheduleId});
    	<selectKey resultType="java.lang.Long" order="AFTER" keyProperty="id">
			SELECT LAST_INSERT_ID() AS id
		</selectKey>
    </insert>
    
    <!-- 更新访谈记录 -->
	<update id="updateById" parameterType="com.galaxy.im.bean.talk.TalkRecordBean">
		update sop_interview_record
		<set>
		  <if test="projectId != null" > project_id = #{projectId}, </if>
		  <if test="fileId != null" > file_id = #{fileId}, </if>
	      <if test="viewDate != null" > view_date = #{viewDate}, </if>
	      <if test="viewTarget != null" > view_target = #{viewTarget}, </if>
	      <if test="viewNotes != null" > view_notes = #{viewNotes}, </if>
	      <if test="viewNotesText != null" > view_notes_text = #{viewNotesText}, </if>
	      <if test="updatedTime != null" > update_time = #{updatedTime} </if>
		</set>
		where id=#{id};
	</update>

</mapper>